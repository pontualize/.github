name: Lembrete de Registro de Ponto

on:
  schedule:
    # Segunda a sexta-feira √†s 9:00, 12:00, 14:00 e 18:00
    - cron: '0 9,12,14,18 * * 1-5'
  workflow_dispatch:

jobs:
  enviar-lembrete:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      discussions: write
    
    steps:
      - name: Definir mensagem do lembrete
        id: mensagem
        run: |
          HORA=$(date +%H)
          
          case $HORA in
            09)
              TIPO="entrada"
              EMOJI="üü¢"
              MENSAGEM="Bom dia! Lembre-se de registrar sua entrada."
              ;;
            12)
              TIPO="saida-almoco"
              EMOJI="üü°"
              MENSAGEM="Hora do almo√ßo! N√£o esque√ßa de registrar sua sa√≠da."
              ;;
            14)
              TIPO="retorno-almoco"
              EMOJI="üü°"
              MENSAGEM="Retornando do almo√ßo? Registre seu retorno."
              ;;
            18)
              TIPO="saida"
              EMOJI="üî¥"
              MENSAGEM="Fim do expediente! Registre sua sa√≠da."
              ;;
            *)
              TIPO="geral"
              EMOJI="‚è∞"
              MENSAGEM="Lembrete de registro de ponto."
              ;;
          esac
          
          echo "tipo=$TIPO" >> $GITHUB_OUTPUT
          echo "emoji=$EMOJI" >> $GITHUB_OUTPUT
          echo "mensagem=$MENSAGEM" >> $GITHUB_OUTPUT
      
      - name: Criar discuss√£o de lembrete
        uses: actions/github-script@v7
        with:
          script: |
            const now = new Date();
            const dataHora = now.toLocaleString('pt-BR', { 
              timeZone: 'America/Sao_Paulo',
              dateStyle: 'full',
              timeStyle: 'short'
            });
            
            const body = `${{ steps.mensagem.outputs.emoji }} **${{ steps.mensagem.outputs.mensagem }}**
            
            üìÖ ${dataHora}
            
            ## Como registrar seu ponto:
            
            1. V√° para a aba **Actions** do reposit√≥rio
            2. Selecione o workflow **"Registro de Ponto Di√°rio"**
            3. Clique em **"Run workflow"**
            4. Escolha a a√ß√£o apropriada: \`${{ steps.mensagem.outputs.tipo }}\`
            5. Adicione observa√ß√µes se necess√°rio
            6. Clique em **"Run workflow"** para confirmar
            
            ---
            
            üí° **Dica:** Voc√™ pode usar o GitHub Mobile para registrar seu ponto de qualquer lugar!
            
            üìä Para consultar seus registros, acesse a pasta \`registros-ponto/\` no reposit√≥rio.
            `;
            
            // Tenta criar uma discuss√£o (se dispon√≠vel)
            try {
              await github.rest.discussions.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: \`${{ steps.mensagem.outputs.emoji }} Lembrete: ${{ steps.mensagem.outputs.tipo }} - \${new Date().toLocaleDateString('pt-BR')}\`,
                body: body,
                category_id: 'general'
              });
            } catch (error) {
              console.log('Discussions n√£o dispon√≠vel, usando issues');
              
              // Fallback para issues se discussions n√£o estiver dispon√≠vel
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: \`${{ steps.mensagem.outputs.emoji }} Lembrete: ${{ steps.mensagem.outputs.tipo }}\`,
                body: body,
                labels: ['lembrete', 'ponto']
              });
            }
